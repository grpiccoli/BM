function loadData(n,t,i){psmb.disable();variables.disable();semaforo&&tl.disable();var u=[],f=[],r=[],e=[];$.each(n,function(n,o){var s=i?[o.value,t.value,o.label,t.label,o.groupId===2?"fito":"graph"]:[t.value,o.value,t.label,o.label,t.groupValue==="Fitoplancton"?"fito":"graph"],h,c;r.push(s[0]+"_"+s[1]);e.push(s[2]+" "+s[3]);h=$.Deferred();f.push(h.promise());c="/ambiental/"+s[4]+"data?area="+s[1]+"&var="+s[0]+"&start="+start+"&end="+end;console.log(c);$.getJSON(c,function(n){u.push(n);h.resolve()})});$.when.apply(null,f).done(function(){u.length!==0&&$.each(chart.data,function(n){for(var t=0;t<u.length;t++)chart.data[n][r[t]]=u[t][n][r[t]]});for(var n=0;n<u.length;n++)series[r[n]]=chart.series.push(new am4charts.LineSeries),series[r[n]].dataFields.valueY=r[n],series[r[n]].dataFields.dateX="date",series[r[n]].name=e[n],series[r[n]].tooltipText="{name}: [bold]{valueY}[/]",series[r[n]].tooltip.pointerOrientation="vertical";chart.invalidateData();psmb.enable();variables.enable();semaforo&&tl.enable()})}function Area(n){return parseFloat(google.maps.geometry.spherical.computeArea(n)/1e4).toFixed(2)}function getBounds(n){var t=new google.maps.LatLngBounds;return Array.isArray(n[0])?$.each(n,function(n,i){$.each(i,function(n,i){t.extend(i)})}):$.each(n,function(n,i){t.extend(i)}),t}var start,end,chart,dataSource,dateAxis,valueAxis,series,semaforo,temp,addListenerOnPolygon;$(".input-daterange").datepicker({inputs:$(".actual_range"),format:"yyyy-MM-dd",language:"es"});start=$("#start").val();end=$("#end").val();am4core.useTheme(am4themes_kelly);chart=am4core.create("chartdiv",am4charts.XYChart);chart.scrollbarX=new am4core.Scrollbar;chart.scrollbarX.parent=chart.bottomAxesContainer;chart.scrollbarY=new am4core.Scrollbar;chart.scrollbarY.parent=chart.leftAxesContainer;chart.language.locale=am4lang_es_ES;dataSource=chart.dataSource;dataSource.url="/ambiental/graphdata?area=1&var=t&start="+start+"&end="+end;dateAxis=chart.xAxes.push(new am4charts.DateAxis);dateAxis.dataFields.category="date";dateAxis.dateFormats.setKey("year","yy");dateAxis.periodChangeDateFormats.setKey("month","MMM yy");dateAxis.tooltipDateFormat="dd MMM, yyyy";dateAxis.renderer.minGridDistance=40;valueAxis=chart.yAxes.push(new am4charts.ValueAxis);chart.cursor=new am4charts.XYCursor;chart.cursor.xAxis=dateAxis;chart.exporting.menu=new am4core.ExportMenu;$.getJSON("/ambiental/exportmenu",function(n){chart.exporting.menu.items=n});series={};semaforo=!$("#semaforo").hasClass("d-none");const epsmb=document.getElementById("psmb");epsmb.addEventListener("addItem",function(n){loadData(variables.getValue(),n.detail,1);polygons[n.detail.value]!==undefined&&n!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})},!1);epsmb.addEventListener("removeItem",function(n){$.each(variables.getValue(!0),function(t,i){name=i+"_"+n.detail.value;chart.series.removeIndex(chart.series.indexOf(series[name])).dispose()});n!==undefined&&google.maps.event.trigger(polygons[n.detail.value],"click",{})},!1);const psmb=new Choices(epsmb,{maxItemCount:10,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,placeholderValue:"Seleccione áreas",searchPlaceholderValue:"Buscar datos",loadingText:"Cargando...",noResultsText:"Sin resultados",noChoicesText:"Sin opciones a elegir",itemSelectText:"Presione para seleccionar",maxItemText:n=>`Máximo ${n} valores`,fuseOptions:{include:"score"}}).ajax(function(n){fetch("/ambiental/psmblist").then(function(t){t.json().then(function(t){n(t,"value","label",!1)})}).catch(function(n){console.error(n)})}),evariable=document.getElementById("variable");evariable.addEventListener("addItem",function(n){loadData(psmb.getValue(),n.detail,0)},!1);evariable.addEventListener("removeItem",function(n){$.each(psmb.getValue(!0),function(t,i){name=n.detail.value+"_"+i;chart.series.removeIndex(chart.series.indexOf(series[name])).dispose()})},!1);const variables=new Choices(evariable,{maxItemCount:10,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,placeholderValue:"Seleccione variables",searchPlaceholderValue:"Buscar datos",loadingText:"Cargando...",noResultsText:"Sin resultados",noChoicesText:"Sin opciones a elegir",itemSelectText:"Presione para seleccionar",maxItemText:n=>`Máximo ${n} valores`,fuseOptions:{include:"score"}}).ajax(function(n){fetch("/ambiental/variablelist").then(function(t){t.json().then(function(t){n(t,"value","label",!1)})}).catch(function(n){console.error(n)})});const etl=document.getElementById("tl");etl.addEventListener("addItem",function(n){var c,l,h,a;if(n.detail.groupValue==="Análisis"){var i=n.detail.value,s=tl.getValue(),u=s.filter(n=>n.groupId===2),f=s.filter(n=>n.groupId===3);if(temp=u,u.length!==0&&f.length!==0){psmb.disable();variables.disable();tl.disable();var r=[],e=[],t=[],o=[];switch(i){case"11":c=s.filter(n=>n.groupId===4);c.length!==0?u.forEach(function(u){f.forEach(function(f){c.forEach(function(s){var h,c;t.push([i,u.value,f.value,s.value].join("_"));o.push([n.detail.name,u.name,f.name,s.name].join(" "));h=$.Deferred();e.push(h.promise());c="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&t="+s.value.slice(1,2)+"&start="+start+"&end="+end;console.log(c);$.getJSON(c,function(n){r.push(n);h.resolve()})})})}):alert("Talla no seleccionada, seleccione requerimientos y luego análisis");break;case"12":l=s.filter(n=>n.groupId===5);l.length!==0?u.forEach(function(u){f.forEach(function(f){l.forEach(function(s){var h,c;t.push([i,u.value,f.value,s.value].join("_"));o.push([n.detail.name,u.name,f.name,s.name].join(" "));h=$.Deferred();e.push(h.promise());c="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&l="+s.value+"&start="+start+"&end="+end;$.getJSON(c,function(n){r.push(n);h.resolve()})})})}):alert("Larva no seleccionada, seleccione requerimientos y luego análisis");break;case"13":h=s.filter(n=>n.groupId===7);h.legnth!==0?u.forEach(function(u){f.forEach(function(f){h.forEach(function(s){var h,c;t.push([i,u.value,f.value,s.value].join("_"));o.push([n.detail.name,u.name,f.name,s.name].join(" "));h=$.Deferred();e.push(h.promise());c="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&s="+s.value+"&start="+start+"&end="+end;$.getJSON(c,function(n){r.push(n);h.resolve()})})})}):alert("Sexo no seleccionado, seleccione requerimientos y luego análisis");break;case"14":u.forEach(function(u){f.forEach(function(f){var s,h;t.push([i,u.value,f.value].join("_"));o.push([n.detail.name,u.name,f.name].join(" "));s=$.Deferred();e.push(s.promise());h="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&start="+start+"&end="+end;$.getJSON(h,function(n){r.push(n);s.resolve()})})});break;case"15":a=s.filter(n=>n.groupId===6);a.legnth!==0?u.forEach(function(u){f.forEach(function(f){a.forEach(function(s){var h,c;t.push([i,u.value,f.value,s.value].join("_"));o.push([n.detail.name,u.name,f.name,s.name].join(" "));h=$.Deferred();e.push(h.promise());c="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&rs="+s.value+"&start="+start+"&end="+end;$.getJSON(c,function(n){r.push(n);h.resolve()})})})}):alert("Estado reproductivo no seleccionado, seleccione requerimientos y luego análisis");break;case"16":h=s.filter(n=>n.groupId===7);h.legnth!==0?u.forEach(function(u){f.forEach(function(f){h.forEach(function(s){var h,c;t.push([i,u.value,f.value,s.value].join("_"));o.push([n.detail.name,u.name,f.name,s.name].join(" "));h=$.Deferred();e.push(h.promise());c="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&s="+s.value+"&start="+start+"&end="+end;$.getJSON(c,function(n){r.push(n);h.resolve()})})})}):alert("Sexo no seleccionado, seleccione requerimientos y luego análisis");break;case"17":u.forEach(function(u){f.forEach(function(f){var s,h;t.push([i,u.value,f.value].join("_"));o.push([n.detail.name,u.name,f.name].join(" "));s=$.Deferred();e.push(s.promise());h="/ambiental/tldata?a="+i+"&psmb="+u.value+"&sp="+f.value+"&start="+start+"&end="+end;$.getJSON(h,function(n){r.push(n);s.resolve()})})})}$.when.apply(null,e).done(function(){r.length!==0&&(temp=r);console.log(r);console.log(t[0]);$.each(chart.data,function(n){for(var i=0;i<r.length;i++)chart.data[n][t[i]]=r[i][n][t[i]]});for(var n=0;n<r.length;n++)series[t[n]]=chart.series.push(new am4charts.LineSeries),series[t[n]].dataFields.valueY=t[n],series[t[n]].dataFields.dateX="date",series[t[n]].name=o[n],series[t[n]].tooltipText="{name}: [bold]{valueY}[/]",series[t[n]].tooltip.pointerOrientation="vertical"});chart.invalidateData();psmb.enable();variables.enable();tl.enable()}else tl.removeActiveItemsByValue(i),alert("PSMB y especie no seleccionados, seleccione requerimientos y luego análisis")}},!1);etl.addEventListener("removeItem",function(n){var f,e;if(n.detail.groupValue==="Análisis"){var i=n.detail.value,t=tl.getValue(),r=t.filter(n=>n.groupId===2),u=t.filter(n=>n.groupId===3);if(r.length!==0&&u.length!==0){psmb.disable();variables.disable();tl.disable();switch(i){case"11":f=t.filter(n=>n.groupId===4);f.length!==0&&r.forEach(function(n){u.forEach(function(t){f.forEach(function(r){name=[i,n.value,t.value,r.value].join("_");chart.series.removeIndex(chart.series.indexOf(series[name])).dispose()})})});break;case"12":e=t.filter(n=>n.groupId===5);e.length!==0&&r.forEach(function(n){u.forEach(function(t){e.forEach(function(r){name=[i,n.value,t.value,r.value].join("_");chart.series.removeIndex(chart.series.indexOf(series[name])).dispose()})})})}}}},!1);const tl=new Choices(etl,{maxItemCount:10,removeItemButton:!0,duplicateItemsAllowed:!1,paste:!1,searchResultLimit:10,shouldSort:!1,placeholderValue:"Variables semáforo",searchPlaceholderValue:"Buscar datos",loadingText:"Cargando...",noResultsText:"Sin resultados",noChoicesText:"Sin opciones a elegir",itemSelectText:"Presione para seleccionar",maxItemText:n=>`Máximo ${n} valores`,fuseOptions:{include:"score"}}).ajax(function(n){semaforo&&fetch("/ambiental/tllist").then(function(t){t.json().then(function(t){n(t,"value","label",!1)})}).catch(function(n){console.error(n)})});addListenerOnPolygon=function(n){var t="red";google.maps.event.addListener(n,"click",function(n){$.isEmptyObject(n)?psmb.getValue(!0).includes(this.zIndex.toString())?this.setOptions({fillColor:t,strokeColor:t}):this.setOptions({fillColor:undefined,strokeColor:undefined}):psmb.getValue(!0).includes(this.zIndex.toString())?(this.setOptions({fillColor:undefined,strokeColor:undefined}),psmb.removeActiveItemsByValue(this.zIndex.toString())):(this.setOptions({fillColor:t,strokeColor:t}),psmb.setChoiceByValue(this.zIndex.toString()))})};var map=new google.maps.Map(document.getElementById("map"),{mapTypeId:"terrain"}),infowindow=new google.maps.InfoWindow({size:new google.maps.Size(150,50)}),polygons={},markers=[];window.onload=function(){$.getJSON("/ambiental/mapdata",function(n){var t=new google.maps.LatLngBounds,i;$.each(n.slice(0,3),function(n,i){$.each(i.position,function(n,i){t.extend(i)})});map.fitBounds(t);map.setCenter(t.getCenter());$.each(n,function(n,t){var i=new google.maps.Polygon({paths:t.position,zIndex:t.id});addListenerOnPolygon(i);polygons[t.id]=i;marker=new google.maps.Marker({position:getBounds(t.position).getCenter(),title:t.name+" "+t.id});google.maps.event.addListener(marker,"click",function(n){return function(){var r="<h4>"+t.name+'<\/h4><table><tr><th>Código<\/th><td align="right">'+t.id+"<\/td><\/tr>";t.comuna!==undefined&&(r+='<tr><th>Comuna<\/th><td align="right">'+t.comuna+"<\/td><\/tr>");t.provincia!==undefined&&(r+='<tr><th>Provincia<\/th><td align="right">'+t.provincia+"<\/td><\/tr>");r+='<tr><th>Región<\/th><td align="right">'+t.region+'<\/td><\/tr><tr><th>Área (ha)<\/th><td align="right">'+Area(i.getPath().getArray())+'<\/td><\/tr><tr><th>Fuentes<\/th><td><\/td><\/tr><tr><td>Sernapesca<\/td><td align="right"><a target="_blank" href="https://www.sernapesca.cl"><img src="../images/ico/sernapesca.svg" height="30" /><\/a><\/td><\/tr><tr><td>PER Mitilidos<\/td><td align="right"><a target="_blank" href="https://www.mejillondechile.cl/"><img src="../images/ico/mejillondechile.min.png" height="30" /><\/a><\/td><\/tr><tr><td>Subpesca<\/td><td align="right"><a target="_blank" href="https://www.subpesca.cl"><img src="../images/ico/subpesca.png" height="30" /><\/a><\/td><\/tr>';infowindow.setContent(r);infowindow.open(map,n);map.setCenter(n.getPosition())}}(marker,n));markers.push(marker);i.setMap(map)});i=new MarkerClusterer(map,markers,{imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});google.maps.event.trigger(polygons[1],"click",{})})};$(function(){$.fn.popover.Constructor.Default.whiteList.table=[];$.fn.popover.Constructor.Default.whiteList.tr=[];$.fn.popover.Constructor.Default.whiteList.th=[];$.fn.popover.Constructor.Default.whiteList.td=[];$.fn.popover.Constructor.Default.whiteList.div=[];$.fn.popover.Constructor.Default.whiteList.tbody=[];$.fn.popover.Constructor.Default.whiteList.thead=[];$("#info").popover({content:$("#infotable").html(),html:!0,container:"body"})});