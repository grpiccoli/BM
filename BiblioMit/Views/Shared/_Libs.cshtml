@model List<string>
@using BiblioMit.Services

@{
    var libs = Libman.LoadJson().libraries;
    var prefix = "";
    if(Model.First() == "TOP") { prefix = Model.First()+"_"; Model.RemoveAt(0); }
    var style = prefix + "Styles";
    var script = prefix + "Scripts";
    var bundles = Bundler.LoadJson();
}

@foreach (var lib in Model)
{
    var library = !lib.StartsWith("/");
    var l = libs.SingleOrDefault(m => m.library.StartsWith($"{lib}@"));
    <environment include="Development">
        @if (library)
        {
            foreach (var file in l.files)
            {
                if (file.Contains(".css"))
                {
                    this.Block(@<link href="@($"{l.destination.Replace("wwwroot", "")}{file}")" rel="stylesheet" />, style);
                }
                else if (file.Contains(".js"))
                {
                    this.Block(@<script src="@($"{l.destination.Replace("wwwroot", "")}{file}")"></script>, script);
                }
            }
        }
        else
        {
            foreach(var bundle in bundles.Where(m => m.outputFileName.Contains(lib)))
            {
                foreach(var input in bundle.inputFiles)
                {
                    var file = input.Replace("wwwroot", "");
                    if (input.Contains(".css"))
                    {
                        this.Block(@<link href="@file" rel="stylesheet" />, style);
                    }
                    else
                    {
                        this.Block(@<script src="@file"></script>, script);
                    }
                }
            }
        }
    </environment>
    <environment exclude="Development">
    @if (library)
    {
        var url = "unpkg.com";
        switch (l.provider)
        {
            case "cdnjs":
                l.library = l.library.Replace("@", "/");
                url = "cdnjs.cloudflare.com/ajax/libs";
                break;
            case "":
            default:
                l.provider = "unpkg";
                break;
        }
        foreach (var file in l.files)
        {
            var path = l.destination.Replace("wwwroot/", "");
            if (file.Contains(".css"))
            {
                this.Block(@<link href="@($"{Context.Request.Scheme}://{url}/{l.library}/{file}")" rel="stylesheet"
                                        asp-fallback-href="@($"{path}{file}")"
                                        asp-subresource-integrity-href="@($"{path}{file}")" />, style);
            }
            else if (file.Contains(".js"))
            {
                this.Block(@<script src="@($"{Context.Request.Scheme}://{url}/{l.library}/{file}")"
                                           asp-fallback-src="@($"{path}{file}")"
                                           asp-subresource-integrity-src="@($"{path}{file}")"></script>, script);
            }
        }
    }
    else
    {
        foreach (var bundle in bundles.Where(m => m.outputFileName.Contains(lib)))
        {
            var path = bundle.outputFileName.Replace("wwwroot", "");
            if (bundle.outputFileName.Contains(".css"))
            {
                this.Block(@<link href="@path" rel="stylesheet" asp-append-version="true" />, style);
            }
            else
            {
                this.Block(@<script src="@path" asp-append-version="true"></script>, script);
            }
        }
    }
    </environment>
}